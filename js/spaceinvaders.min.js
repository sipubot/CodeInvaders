function Game(){this.config={bombRate:.05,bombMinVelocity:50,bombMaxVelocity:50,invaderInitialVelocity:25,invaderAcceleration:0,invaderDropDistance:20,rocketVelocity:120,
rocketMaxFireRate:2,gameWidth:400,gameHeight:300,fps:50,debugMode:!1,invaderRanks:1,invaderFiles:10,shipSpeed:120,levelDifficultyMultiplier:.2,pointsPerInvader:5
},this.lives=3,this.width=0,this.height=0,this.gameBounds={left:0,top:0,right:0,bottom:0},this.intervalId=0,this.score=0,this.stage=0,this.level=1,this.stateStack=[],
this.pressedKeys={},this.gameCanvas=null,this.sounds=null,this.backgroundScreen=null}function GameLoop(t){var e=t.currentState();if(e){var i=1/t.config.fps,s=this.gameCanvas.getContext("2d");
e.update&&e.update(t,i),e.draw&&e.draw(t,i,s)}}function WelcomeState(){}function GameOverState(){}function PlayState(t,e){this.config=t,this.level=e,this.invaderCurrentVelocity=10,
this.invaderCurrentDropDistance=0,this.invadersAreDropping=!1,this.lastRocketTime=null,this.ship=null,this.boss={},this.invaders=[],this.rockets=[],this.bombs=[];
}function PauseState(){}function LevelIntroState(t){this.level=t,this.countdownMessage="3",this.IntroStageWord="This is Just Game"}function Ship(t,e){this.x=t,this.y=e,
this.width=20,this.height=16}function Rocket(t,e,i){this.x=t,this.y=e,this.velocity=i}function Bomb(t,e,i){this.x=t,this.y=e,this.velocity=i}function Invader(t,e,i,s,o){
this.x=t,this.y=e,this.rank=i,this.file=s,this.type=o,this.width=18,this.height=14}function Boss(t,e,i){this.x=t,this.y=e,this.stage=i,this.hp=1e3,this.movedirection=-1,
this.width=80,this.height=40}function GameState(t,e,i,s,o,n){this.updateProc=t,this.drawProc=e,this.keyDown=i,this.keyUp=s,this.enter=o,this.leave=n}function Sounds(){
this.audioContext=null,this.sounds={}}Game.prototype.initialise=function(t){this.gameCanvas=t,this.width=t.width,this.height=t.height,this.gameBounds={left:t.width/2-this.config.gameWidth/2,
right:t.width/2+this.config.gameWidth/2,top:t.height/2-this.config.gameHeight/2,bottom:t.height/2+this.config.gameHeight/2}},Game.prototype.setStage=function(t){
this.stage=t},Game.prototype.moveToState=function(t){this.currentState()&&this.currentState().leave&&(this.currentState().leave(game),this.stateStack.pop()),t.enter&&t.enter(game),
this.stateStack.pop(),this.stateStack.push(t)},Game.prototype.start=function(){this.moveToState(new WelcomeState),this.lives=3,this.config.debugMode=/debug=true/.test(window.location.href);
var t=this;this.intervalId=setInterval(function(){GameLoop(t)},1e3/this.config.fps)},Game.prototype.currentState=function(){return this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;
},Game.prototype.mute=function(t){t===!0?this.sounds.mute=!0:t===!1?this.sounds.mute=!1:this.sounds.mute=!this.sounds.mute},Game.prototype.pushState=function(t){
t.enter&&t.enter(game),this.stateStack.push(t)},Game.prototype.popState=function(){this.currentState()&&(this.currentState().leave&&this.currentState().leave(game),
this.stateStack.pop())},Game.prototype.stop=function(){clearInterval(this.intervalId)},Game.prototype.keyDown=function(t){this.pressedKeys[t]=!0,this.currentState()&&this.currentState().keyDown&&this.currentState().keyDown(this,t);
},Game.prototype.keyUp=function(t){delete this.pressedKeys[t],this.currentState()&&this.currentState().keyUp&&this.currentState().keyUp(this,t)},WelcomeState.prototype.enter=function(t){
t.sounds=new Sounds,t.sounds.init(),t.sounds.loadSound("shoot","sounds/shoot.wav"),t.sounds.loadSound("bang","sounds/bang.wav"),t.sounds.loadSound("explosion","sounds/explosion.wav");
},WelcomeState.prototype.update=function(t,e){},WelcomeState.prototype.draw=function(t,e,i){i.clearRect(0,0,t.width,t.height),i.font="30px Arial",i.fillStyle="#ffffff",
i.textBaseline="center",i.textAlign="center",i.fillText("Code Invaders",t.width/2,t.height/2-40),i.font="16px Arial",i.fillText("Select Stage",t.width/2,t.height/2);
},WelcomeState.prototype.keyDown=function(t,e){32==e&&(t.level=1,t.score=0,t.lives=3,t.moveToState(new LevelIntroState(t.level)))},GameOverState.prototype.update=function(t,e){},
GameOverState.prototype.draw=function(t,e,i){i.clearRect(0,0,t.width,t.height),i.font="30px Arial",i.fillStyle="#ffffff",i.textBaseline="center",i.textAlign="center",
i.fillText("Game Over!",t.width/2,t.height/2-40),i.font="16px Arial",i.fillText("You scored "+t.score+" and got to level "+t.level,t.width/2,t.height/2),i.font="16px Arial",
i.fillText("Press 'Space' to play again.",t.width/2,t.height/2+40)},GameOverState.prototype.keyDown=function(t,e){32==e&&(t.lives=3,t.score=0,t.level=1,t.moveToState(new LevelIntroState(1)));
},PlayState.prototype.enter=function(t){this.ship=new Ship(t.width/2,t.gameBounds.bottom),this.invaderCurrentVelocity=10,this.invaderCurrentDropDistance=0,this.invadersAreDropping=!1;
var e=this.level*this.config.levelDifficultyMultiplier;this.shipSpeed=this.config.shipSpeed,this.invaderInitialVelocity=this.config.invaderInitialVelocity+e*this.config.invaderInitialVelocity,
this.bombRate=this.config.bombRate+e*this.config.bombRate,this.bombMinVelocity=this.config.bombMinVelocity+e*this.config.bombMinVelocity,this.bombMaxVelocity=this.config.bombMaxVelocity+e*this.config.bombMaxVelocity;
for(var i=this.config.invaderRanks,s=this.config.invaderFiles,o=[],n=0;n<i;n++)for(var h=0;h<s;h++)o.push(new Invader(t.width/2+200*(s/2-h)/s,t.gameBounds.top+20*n,n,h,"Invader"));
this.invaders=o,this.invaderCurrentVelocity=this.invaderInitialVelocity,this.invaderVelocity={x:-this.invaderInitialVelocity,y:0},this.invaderNextVelocity=null;var a=new Boss(t.width/2,200,t.stage);
this.boss=a},PlayState.prototype.update=function(t,e){t.pressedKeys[37]&&(this.ship.x-=this.shipSpeed*e),t.pressedKeys[39]&&(this.ship.x+=this.shipSpeed*e),t.pressedKeys[32]&&this.fireRocket(),
this.ship.x<t.gameBounds.left&&(this.ship.x=t.gameBounds.left),this.ship.x>t.gameBounds.right&&(this.ship.x=t.gameBounds.right);for(var i=0;i<this.bombs.length;i++){
var s=this.bombs[i];s.y+=e*s.velocity,s.y>this.height&&this.bombs.splice(i--,1)}for(i=0;i<this.rockets.length;i++){var o=this.rockets[i];o.y-=e*o.velocity,o.y<0&&this.rockets.splice(i--,1);
}var n=!1,h=!1,a=!1;for(i=0;i<this.invaders.length;i++){var r=this.invaders[i],l=r.x+this.invaderVelocity.x*e,c=r.y+this.invaderVelocity.y*e;n===!1&&l<t.gameBounds.left?n=!0:h===!1&&l>t.gameBounds.right?h=!0:a===!1&&c>t.gameBounds.bottom&&(a=!0),
n||h||a||(r.x=l,r.y=c)}for(this.invadersAreDropping&&(this.invaderCurrentDropDistance+=this.invaderVelocity.y*e,this.invaderCurrentDropDistance>=this.config.invaderDropDistance&&(this.invadersAreDropping=!1,
this.invaderVelocity=this.invaderNextVelocity,this.invaderCurrentDropDistance=0)),n&&(this.invaderCurrentVelocity+=this.config.invaderAcceleration,this.invaderVelocity={
x:0,y:this.invaderCurrentVelocity},this.invadersAreDropping=!0,this.invaderNextVelocity={x:this.invaderCurrentVelocity,y:0}),h&&(this.invaderCurrentVelocity+=this.config.invaderAcceleration,
this.invaderVelocity={x:0,y:this.invaderCurrentVelocity},this.invadersAreDropping=!0,this.invaderNextVelocity={x:-this.invaderCurrentVelocity,y:0}),this.boss.x>400&&(this.boss.movedirection=1),
this.boss.x<200&&(this.boss.movedirection=-1),this.boss.x=this.boss.x-e*this.boss.movedirection*30,a&&(this.lives=0),i=0;i<this.invaders.length;i++){for(var r=this.invaders[i],d=!1,u=0;u<this.rockets.length;u++){
var o=this.rockets[u];if(o.x>=r.x-r.width/2&&o.x<=r.x+r.width/2&&o.y>=r.y-r.height/2&&o.y<=r.y+r.height/2){this.rockets.splice(u--,1),d=!0,t.score+=this.config.pointsPerInvader;
break}}d&&(this.invaders.splice(i--,1),t.sounds.playSound("bang"))}for(var f=this.boss,p=!1,u=0;u<this.rockets.length;u++){var o=this.rockets[u];if(o.x>=f.x-f.width/2&&o.x<=f.x+f.width/2&&o.y>=f.y-f.height/2&&o.y<=f.y+f.height/2){
this.rockets.splice(u--,1),p=!0,t.score+=this.config.pointsPerInvader;break}}p&&(this.boss.hp=this.boss.hp-20,0===this.boss.hp,t.sounds.playSound("bang"));for(var v={},i=0;i<this.invaders.length;i++){
var r=this.invaders[i];(!v[r.file]||v[r.file].rank<r.rank)&&(v[r.file]=r)}for(var i=0;i<this.config.invaderFiles;i++){var r=v[i];if(r){var g=this.bombRate*e;g>Math.random()&&this.bombs.push(new Bomb(r.x,r.y+r.height/2,this.bombMinVelocity+Math.random()*(this.bombMaxVelocity-this.bombMinVelocity)));
}}for(var i=0;i<this.bombs.length;i++){var s=this.bombs[i];s.x>=this.ship.x-this.ship.width/2&&s.x<=this.ship.x+this.ship.width/2&&s.y>=this.ship.y-this.ship.height/2&&s.y<=this.ship.y+this.ship.height/2&&(this.bombs.splice(i--,1),
t.lives--,t.sounds.playSound("explosion"))}for(var i=0;i<this.invaders.length;i++){var r=this.invaders[i];r.x+r.width/2>this.ship.x-this.ship.width/2&&r.x-r.width/2<this.ship.x+this.ship.width/2&&r.y+r.height/2>this.ship.y-this.ship.height/2&&r.y-r.height/2<this.ship.y+this.ship.height/2&&(t.lives=0,
t.sounds.playSound("explosion"))}t.lives<=0&&t.moveToState(new GameOverState),0===this.invaders.length&&(t.score+=50*this.level,t.level+=1,t.moveToState(new LevelIntroState(t.level)));
},PlayState.prototype.draw=function(t,e,i){i.clearRect(0,0,t.width,t.height),i.fillStyle="#999999",i.fillRect(this.ship.x-this.ship.width/2,this.ship.y-this.ship.height/2,this.ship.width,this.ship.height),
i.fillStyle="#006600";for(var s=0;s<this.invaders.length;s++){var o=this.invaders[s];i.fillRect(o.x-o.width/2,o.y-o.height/2,o.width,o.height)}i.fillStyle="#008800";
var n=this.boss;i.fillRect(n.x-n.width/2,n.y-n.height/2,n.width,n.height),console.log(n),i.fillStyle="#ff5555";for(var s=0;s<this.bombs.length;s++){var h=this.bombs[s];
i.fillRect(h.x-2,h.y-2,4,4)}i.fillStyle="#ff0000";for(var s=0;s<this.rockets.length;s++){var a=this.rockets[s];i.fillRect(a.x,a.y-2,1,4)}var r=t.gameBounds.bottom+(t.height-t.gameBounds.bottom)/2+7;
i.font="14px Arial",i.fillStyle="#ffffff";var l="Lives: "+t.lives;i.textAlign="left",i.fillText(l,t.gameBounds.left,r),l="Score: "+t.score+", Level: "+t.level,i.textAlign="right",
i.fillText(l,t.gameBounds.right,r),this.config.debugMode&&(i.strokeStyle="#ff0000",i.strokeRect(0,0,t.width,t.height),i.strokeRect(t.gameBounds.left,t.gameBounds.top,t.gameBounds.right-t.gameBounds.left,t.gameBounds.bottom-t.gameBounds.top));
},PlayState.prototype.keyDown=function(t,e){32==e&&this.fireRocket(),80==e&&t.pushState(new PauseState)},PlayState.prototype.keyUp=function(t,e){},PlayState.prototype.fireRocket=function(){
(null===this.lastRocketTime||(new Date).valueOf()-this.lastRocketTime>1e3/this.config.rocketMaxFireRate)&&(this.rockets.push(new Rocket(this.ship.x,this.ship.y-12,this.config.rocketVelocity)),
this.lastRocketTime=(new Date).valueOf(),game.sounds.playSound("shoot"))},PauseState.prototype.keyDown=function(t,e){80==e&&t.popState()},PauseState.prototype.draw=function(t,e,i){
i.clearRect(0,0,t.width,t.height),i.font="14px Arial",i.fillStyle="#ffffff",i.textBaseline="middle",i.textAlign="center",i.fillText("Paused",t.width/2,t.height/2);
},LevelIntroState.prototype.update=function(t,e){void 0===this.countdown&&(this.countdown=3),this.countdown-=e,this.countdown<2&&(this.countdownMessage="2"),this.countdown<1&&(this.countdownMessage="1"),
this.countdown<=0&&t.moveToState(new PlayState(t.config,this.level))},LevelIntroState.prototype.draw=function(t,e,i){void 0===this.count&&(this.count=0),this.count+=e*t.config.fps,
i.font="68px Arial",i.textBaseline="middle",i.fillStyle="#ffffff",i.textAlign="center",i.fillText(this.IntroStageWord,t.width/2,46*Math.ceil(this.count/10)),i.clearRect(t.width/2-120,t.height/2-60,240,160),
i.fillStyle="#111111",i.fillRect(t.width/2-120,t.height/2-60,240,160),i.font="36px Arial",i.fillStyle="#ffffff",i.textBaseline="middle",i.textAlign="center",i.fillText("Level "+this.level,t.width/2,t.height/2),
i.font="24px Arial",i.fillText("Ready in "+this.countdownMessage,t.width/2,t.height/2+36)},Sounds.prototype.init=function(){context=window.AudioContext||window.webkitAudioContext,
this.audioContext=new context,this.mute=!1},Sounds.prototype.loadSound=function(t,e){var i=this;this.sounds[t]=null;var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",
s.onload=function(){i.audioContext.decodeAudioData(s.response,function(e){i.sounds[t]={buffer:e}})};try{s.send()}catch(e){console.log("An exception occured getting sound the sound "+t+" this might be because the page is running from the file system, not a webserver."),
console.log(e)}},Sounds.prototype.playSound=function(t){if(void 0!==this.sounds[t]&&null!==this.sounds[t]&&this.mute!==!0){var e=this.audioContext.createBufferSource();
e.buffer=this.sounds[t].buffer,e.connect(this.audioContext.destination),e.start(0)}};